name: Check for new Deno release

on:
  schedule:
    - cron: '0 */12 * * *' # every 12 hours
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check_new_deno:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch latest Deno release
        id: deno
        run: |
          tag=$(curl -s https://api.github.com/repos/denoland/deno/releases/latest | jq -r .tag_name)
          echo "Latest Deno release: $tag"
          echo "deno_tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Check if tag with this Deno version exists in DenoHost
        id: check
        run: |
          deno_tag=${{ steps.deno.outputs.deno_tag }}
          git_tags=$(git ls-remote --tags https://github.com/thomas3577/DenoHost.git | awk -F/ '{print $NF}')
          found=$(echo "$git_tags" | grep -E "^v${deno_tag}(-|$)" || true)

          if [[ -n "$found" ]]; then
            echo "✅ Already released: $found"
            echo "already_exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "⚠️ No existing tag for v$deno_tag"
            echo "already_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create new tag and push
        if: steps.check.outputs.already_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          git init
          git remote add origin https://github.com/thomas3577/DenoHost.git
          git fetch origin main

          deno_tag=${{ steps.deno.outputs.deno_tag }}
          new_tag="v${deno_tag}-alpha.1"

          git tag "$new_tag" origin/main
          git push origin "$new_tag"
